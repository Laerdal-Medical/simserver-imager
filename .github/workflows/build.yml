name: Build and Package

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  QT_VERSION: '6.8.2'
  BUILD_TYPE: MinSizeRel

jobs:
  # ============================================================================
  # Linux Builds
  # ============================================================================
  build-linux:
    name: Linux (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-24.04
            qt_arch: linux_gcc_64
          - arch: aarch64
            runner: ubuntu-24.04-arm
            qt_arch: linux_gcc_arm64
            qt_host: linux_arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for version detection

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libgnutls28-dev \
            libfuse2 \
            fuse \
            libgl1-mesa-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-0 \
            libxcb-cursor0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-xinerama0 \
            libxcb-xfixes0

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: ${{ matrix.qt_host || 'linux' }}
          arch: ${{ matrix.qt_arch }}
          cache: true

      - name: Configure CMake
        run: |
          cmake -B build -S src \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DQt6_ROOT="${QT_ROOT_DIR}"

      - name: Build
        run: cmake --build build --parallel

      - name: Create AppImage
        run: |
          chmod +x create-appimage.sh
          ./create-appimage.sh --arch=${{ matrix.arch }} --qt-root="${QT_ROOT_DIR}" --no-clean

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage-${{ matrix.arch }}
          # Only upload the versioned AppImage, not the symlinks
          path: 'Laerdal_SimServer_Imager-*-desktop-${{ matrix.arch }}.AppImage'
          if-no-files-found: error

  # ============================================================================
  # Linux Debian Packages (Desktop only - CLI requires separate AppImage build)
  # ============================================================================
  build-debian:
    name: Debian Package (desktop)
    runs-on: ubuntu-24.04
    needs: build-linux

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download AppImage artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-appimage-x86_64
          path: .

      - name: Prepare AppImage for packaging
        run: |
          # List downloaded files
          ls -la *.AppImage

          # The debian packaging expects: laerdal-simserver-imager-x86_64.AppImage
          for f in *desktop*.AppImage Laerdal_SimServer_Imager*.AppImage; do
            if [ -f "$f" ]; then
              cp "$f" "laerdal-simserver-imager-x86_64.AppImage"
              break
            fi
          done

          ls -la *.AppImage

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libgnutls28-dev \
            devscripts \
            debhelper \
            dh-exec \
            fakeroot

      - name: Build Debian package
        run: |
          # Build the debian package with desktop profile
          dpkg-buildpackage -uc -us -b -Pdesktop
          # Copy deb files to workspace (upload-artifact doesn't allow ../)
          cp ../*.deb .

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: debian-desktop
          path: '*.deb'
          if-no-files-found: error

  # ============================================================================
  # Windows Build (MinGW)
  # ============================================================================
  build-windows:
    name: Windows
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: windows
          arch: win64_mingw
          cache: true

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
          echo "C:\Program Files (x86)\Inno Setup 6" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Configure CMake
        shell: msys2 {0}
        run: |
          cmake -B build -S src \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DQt6_ROOT="$QT_ROOT_DIR" \
            -DENABLE_INNO_INSTALLER=ON

      - name: Build
        shell: msys2 {0}
        run: cmake --build build --parallel

      - name: Build Inno Setup installer
        shell: msys2 {0}
        run: cmake --build build --target inno_installer

      - name: Create ZIP archive
        run: |
          $version = git describe --tags --always
          Compress-Archive -Path build\deploy\* -DestinationPath "laerdal-simserver-imager-$version-windows-x64.zip"

      - name: Upload Windows ZIP
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-zip
          path: '*.zip'
          if-no-files-found: error

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-installer
          path: build/installer/*.exe
          if-no-files-found: error

  # ============================================================================
  # macOS Build
  # ============================================================================
  build-macos:
    name: macOS (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: macos-15
          - arch: arm64
            runner: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: mac
          arch: clang_64
          cache: true

      - name: Configure CMake
        run: |
          cmake -B build -S src \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DQt6_ROOT="${QT_ROOT_DIR}" \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }}

      - name: Build
        run: cmake --build build --parallel

      - name: Create DMG
        run: |
          cd build
          # Deploy Qt frameworks to the app bundle
          # The CMake creates laerdal-simserver-imager.app
          macdeployqt laerdal-simserver-imager.app -qmldir=../src

          # Create DMG
          VERSION=$(git describe --tags --always)
          hdiutil create -volname "Laerdal SimServer Imager" \
            -srcfolder laerdal-simserver-imager.app \
            -ov -format UDZO \
            "laerdal-simserver-imager-${VERSION}-macos-${{ matrix.arch }}.dmg"

      - name: Upload macOS build
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: build/*.dmg
          if-no-files-found: error

  # ============================================================================
  # Create Release
  # ============================================================================
  release:
    name: Create Release
    needs: [build-linux, build-debian, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: find artifacts -type f | head -50

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: |
            artifacts/**/*.AppImage
            artifacts/**/*.deb
            artifacts/**/*.zip
            artifacts/**/*.exe
            artifacts/**/*.dmg
