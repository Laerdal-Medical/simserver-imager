name: Build and Package

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  QT_VERSION: '6.8.2'
  BUILD_TYPE: MinSizeRel

jobs:
  # ============================================================================
  # Linux Builds
  # ============================================================================
  build-linux:
    name: Linux (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-24.04
            qt_arch: linux_gcc_64
          - arch: aarch64
            runner: ubuntu-24.04-arm
            qt_arch: linux_gcc_arm64
            qt_host: linux_arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for version detection

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libgnutls28-dev \
            liburing-dev \
            libfuse2 \
            fuse \
            libgl1-mesa-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-0 \
            libxcb-cursor0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-xinerama0 \
            libxcb-xfixes0

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: ${{ matrix.qt_host || 'linux' }}
          arch: ${{ matrix.qt_arch }}
          cache: true

      - name: Configure CMake
        run: |
          cmake -B build -S src \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DQt6_ROOT="${QT_ROOT_DIR}"

      - name: Build
        run: cmake --build build --parallel

      - name: Create AppImage
        run: |
          # Restore any tracked files modified by the build process so git describe is clean
          # This only affects tracked files, not the build/ output directory
          git checkout -- src/ || true
          chmod +x create-appimage.sh
          ./create-appimage.sh --arch=${{ matrix.arch }} --qt-root="${QT_ROOT_DIR}" --no-clean

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage-${{ matrix.arch }}
          # Only upload the versioned AppImage, not the symlinks
          path: 'Laerdal_SimServer_Imager-*-desktop-${{ matrix.arch }}.AppImage'
          if-no-files-found: error

      # Build Debian package - done here so CMake-generated metainfo.xml is available
      - name: Prepare AppImage for Debian packaging
        run: |
          # dh-exec doesn't support globs, create expected symlink
          ln -sf Laerdal_SimServer_Imager-*-desktop-${{ matrix.arch }}.AppImage \
            laerdal-simserver-imager-${{ matrix.arch }}.AppImage

      - name: Install Debian build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper dh-exec fakeroot

      - name: Build Debian package
        run: |
          dpkg-buildpackage -uc -us -b -Pdesktop
          cp ../*.deb .

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: debian-${{ matrix.arch }}
          path: '*.deb'
          if-no-files-found: error

  # ============================================================================
  # Windows Build (MinGW)
  # ============================================================================
  build-windows:
    name: Windows
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: windows
          arch: win64_mingw
          tools: 'tools_mingw1310 tools_ninja'
          cache: true

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
          echo "C:\Program Files (x86)\Inno Setup 6" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Configure CMake
        run: |
          $env:Path = "$env:IQTA_TOOLS\mingw1310_64\bin;$env:IQTA_TOOLS\Ninja;$env:Path"
          cmake -B build -S src `
            -G Ninja `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DQt6_ROOT="$env:QT_ROOT_DIR" `
            -DMINGW64_ROOT="$env:IQTA_TOOLS\mingw1310_64" `
            -DCMAKE_C_COMPILER="$env:IQTA_TOOLS\mingw1310_64\bin\gcc.exe" `
            -DCMAKE_CXX_COMPILER="$env:IQTA_TOOLS\mingw1310_64\bin\g++.exe" `
            -DCMAKE_MAKE_PROGRAM="$env:IQTA_TOOLS\Ninja\ninja.exe" `
            -DENABLE_INNO_INSTALLER=ON

      - name: Build
        run: |
          $env:Path = "$env:IQTA_TOOLS\mingw1310_64\bin;$env:IQTA_TOOLS\Ninja;$env:Path"
          cmake --build build --parallel

      - name: Build Inno Setup installer
        run: |
          $env:Path = "$env:IQTA_TOOLS\mingw1310_64\bin;$env:IQTA_TOOLS\Ninja;$env:Path"
          cmake --build build --target inno_installer

      - name: Create ZIP archive
        run: |
          $version = git describe --tags --always
          Compress-Archive -Path build\deploy\* -DestinationPath "laerdal-simserver-imager-$version-windows-x64.zip"

      - name: Upload Windows ZIP
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-zip
          path: '*.zip'
          if-no-files-found: error

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-installer
          path: build/installer/*.exe
          if-no-files-found: error

  # ============================================================================
  # macOS Build
  # ============================================================================
  build-macos:
    name: macOS (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: macos-15
          - arch: arm64
            runner: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: mac
          arch: clang_64
          cache: true

      - name: Configure CMake
        run: |
          cmake -B build -S src \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DQt6_ROOT="${QT_ROOT_DIR}" \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }}

      - name: Build
        run: cmake --build build --parallel

      - name: Create DMG
        run: |
          cd build
          APP_BUNDLE="laerdal-simserver-imager.app"

          # macdeployqt is already run by CMake post-build, but run again to be safe
          macdeployqt "${APP_BUNDLE}" -qmldir=../src

          # Ad-hoc sign the app bundle (required for Gatekeeper on macOS)
          # This allows the app to run without a paid Apple Developer certificate
          echo "Ad-hoc signing the app bundle..."
          codesign --force --deep --sign - "${APP_BUNDLE}"

          # Verify the signature
          echo "Verifying signature..."
          codesign --verify --verbose "${APP_BUNDLE}" || echo "Warning: Signature verification had issues"

          # Create DMG
          VERSION=$(git describe --tags --always)
          hdiutil create -volname "Laerdal SimServer Imager" \
            -srcfolder "${APP_BUNDLE}" \
            -ov -format UDZO \
            "laerdal-simserver-imager-${VERSION}-macos-${{ matrix.arch }}.dmg"

      - name: Upload macOS build
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: build/*.dmg
          if-no-files-found: error

  # ============================================================================
  # Create Release
  # ============================================================================
  release:
    name: Create Release
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    # Run on pushes to main branch OR tag pushes (not PRs)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Determine release parameters
        id: release_params
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Tag push: finalize release (not draft)
            VERSION="${{ github.ref_name }}"
            echo "tag=$VERSION" >> $GITHUB_OUTPUT
            echo "draft=false" >> $GITHUB_OUTPUT
            echo "name=Release $VERSION" >> $GITHUB_OUTPUT
          else
            # Main branch push: create/update draft release
            VERSION=$(git describe --tags --always)
            echo "tag=draft" >> $GITHUB_OUTPUT
            echo "draft=true" >> $GITHUB_OUTPUT
            echo "name=Next Release (Draft)" >> $GITHUB_OUTPUT
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Prepare release notes
        run: |
          # Replace placeholder with actual version
          sed "s/{{VERSION}}/${{ steps.release_params.outputs.version }}/g" RELEASE_NOTES.md > RELEASE_NOTES_FINAL.md

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: find artifacts -type f | head -50

      - name: Delete existing draft release
        run: |
          # Delete existing draft release and tag if they exist
          gh release delete draft --yes || true
          git push origin :refs/tags/draft || true
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_params.outputs.tag }}
          name: ${{ steps.release_params.outputs.name }}
          draft: ${{ steps.release_params.outputs.draft == 'true' }}
          body_path: RELEASE_NOTES_FINAL.md
          files: |
            artifacts/**/*.AppImage
            artifacts/**/*.deb
            artifacts/**/*.zip
            artifacts/**/*.exe
            artifacts/**/*.dmg

  # ============================================================================
  # Lint
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check CMake formatting
        run: |
          pip install cmake-format
          find src -name 'CMakeLists.txt' -o -name '*.cmake' | \
            xargs cmake-format --check || echo "CMake format check failed (non-blocking)"
