name: Build and Package

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  QT_VERSION: '6.8.2'
  BUILD_TYPE: MinSizeRel

jobs:
  # ============================================================================
  # Linux Builds
  # ============================================================================
  build-linux:
    name: Linux (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-24.04
            qt_arch: linux_gcc_64
          - arch: aarch64
            runner: ubuntu-24.04-arm
            qt_arch: linux_gcc_arm64
            qt_host: linux_arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for version detection

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libgnutls28-dev \
            libfuse2 \
            fuse \
            libgl1-mesa-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-0 \
            libxcb-cursor0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-xinerama0 \
            libxcb-xfixes0

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: ${{ matrix.qt_host || 'linux' }}
          arch: ${{ matrix.qt_arch }}
          cache: true

      - name: Configure CMake
        run: |
          cmake -B build -S src \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DQt6_ROOT="${QT_ROOT_DIR}"

      - name: Build
        run: cmake --build build --parallel

      - name: Create AppImage
        run: |
          # Restore any tracked files modified by the build process so git describe is clean
          # This only affects tracked files, not the build/ output directory
          git checkout -- src/ || true
          chmod +x create-appimage.sh
          ./create-appimage.sh --arch=${{ matrix.arch }} --qt-root="${QT_ROOT_DIR}" --no-clean

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage-${{ matrix.arch }}
          # Only upload the versioned AppImage, not the symlinks
          path: 'Laerdal_SimServer_Imager-*-desktop-${{ matrix.arch }}.AppImage'
          if-no-files-found: error

  # ============================================================================
  # Linux Debian Packages (Desktop only - CLI requires separate AppImage build)
  # ============================================================================
  build-debian:
    name: Debian Package (desktop)
    runs-on: ubuntu-24.04
    needs: build-linux

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download AppImage artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-appimage-x86_64
          path: .

      - name: Prepare AppImage for packaging
        run: |
          # List downloaded files
          ls -la *.AppImage

          # The debian packaging expects: laerdal-simserver-imager-x86_64.AppImage
          for f in *desktop*.AppImage Laerdal_SimServer_Imager*.AppImage; do
            if [ -f "$f" ]; then
              cp "$f" "laerdal-simserver-imager-x86_64.AppImage"
              break
            fi
          done

          ls -la *.AppImage

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libgnutls28-dev \
            devscripts \
            debhelper \
            dh-exec \
            fakeroot

      - name: Build Debian package
        run: |
          # Build the debian package with desktop profile
          dpkg-buildpackage -uc -us -b -Pdesktop
          # Copy deb files to workspace (upload-artifact doesn't allow ../)
          cp ../*.deb .

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: debian-desktop
          path: '*.deb'
          if-no-files-found: error

  # ============================================================================
  # Windows Build (MinGW)
  # ============================================================================
  build-windows:
    name: Windows
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: windows
          arch: win64_mingw
          tools: 'tools_mingw1310 tools_ninja'
          cache: true

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
          echo "C:\Program Files (x86)\Inno Setup 6" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Configure CMake
        run: |
          $env:Path = "$env:IQTA_TOOLS\mingw1310_64\bin;$env:IQTA_TOOLS\Ninja;$env:Path"
          cmake -B build -S src `
            -G Ninja `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DQt6_ROOT="$env:QT_ROOT_DIR" `
            -DMINGW64_ROOT="$env:IQTA_TOOLS\mingw1310_64" `
            -DCMAKE_C_COMPILER="$env:IQTA_TOOLS\mingw1310_64\bin\gcc.exe" `
            -DCMAKE_CXX_COMPILER="$env:IQTA_TOOLS\mingw1310_64\bin\g++.exe" `
            -DCMAKE_MAKE_PROGRAM="$env:IQTA_TOOLS\Ninja\ninja.exe" `
            -DENABLE_INNO_INSTALLER=ON

      - name: Build
        run: |
          $env:Path = "$env:IQTA_TOOLS\mingw1310_64\bin;$env:IQTA_TOOLS\Ninja;$env:Path"
          cmake --build build --parallel

      - name: Build Inno Setup installer
        run: |
          $env:Path = "$env:IQTA_TOOLS\mingw1310_64\bin;$env:IQTA_TOOLS\Ninja;$env:Path"
          cmake --build build --target inno_installer

      - name: Create ZIP archive
        run: |
          $version = git describe --tags --always
          Compress-Archive -Path build\deploy\* -DestinationPath "laerdal-simserver-imager-$version-windows-x64.zip"

      - name: Upload Windows ZIP
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-zip
          path: '*.zip'
          if-no-files-found: error

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-installer
          path: build/installer/*.exe
          if-no-files-found: error

  # ============================================================================
  # macOS Build
  # ============================================================================
  build-macos:
    name: macOS (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: macos-15
          - arch: arm64
            runner: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: mac
          arch: clang_64
          cache: true

      - name: Configure CMake
        run: |
          cmake -B build -S src \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DQt6_ROOT="${QT_ROOT_DIR}" \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }}

      - name: Build
        run: cmake --build build --parallel

      - name: Create DMG
        run: |
          cd build
          # Deploy Qt frameworks to the app bundle
          # The CMake creates laerdal-simserver-imager.app
          macdeployqt laerdal-simserver-imager.app -qmldir=../src

          # Create DMG
          VERSION=$(git describe --tags --always)
          hdiutil create -volname "Laerdal SimServer Imager" \
            -srcfolder laerdal-simserver-imager.app \
            -ov -format UDZO \
            "laerdal-simserver-imager-${VERSION}-macos-${{ matrix.arch }}.dmg"

      - name: Upload macOS build
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: build/*.dmg
          if-no-files-found: error

  # ============================================================================
  # Create Release
  # ============================================================================
  release:
    name: Create Release
    needs: [build-linux, build-debian, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Get tag message
        id: tag_message
        run: |
          # Debug: show tag info
          echo "Tag name: ${{ github.ref_name }}"
          echo "Tag type:"
          git cat-file -t "${{ github.ref_name }}" || echo "Tag not found"

          # Get the annotated tag message (excluding the tag name line)
          TAG_MESSAGE=$(git tag -l --format='%(contents)' "${{ github.ref_name }}")

          # Debug: show first few lines
          echo "Tag message preview:"
          echo "$TAG_MESSAGE" | head -10

          # Write to file for multiline handling
          echo "$TAG_MESSAGE" > tag_message.txt
          echo "Retrieved tag message for ${{ github.ref_name }}"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: find artifacts -type f | head -50

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          body_path: tag_message.txt
          files: |
            artifacts/**/*.AppImage
            artifacts/**/*.deb
            artifacts/**/*.zip
            artifacts/**/*.exe
            artifacts/**/*.dmg

  # ============================================================================
  # Lint
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check CMake formatting
        run: |
          pip install cmake-format
          find src -name 'CMakeLists.txt' -o -name '*.cmake' | \
            xargs cmake-format --check || echo "CMake format check failed (non-blocking)"
